<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard User - RECHAIN OIL</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" href="assets/images/logo.png" type="image/png">
    <style>
        body { 
            background: #f8f9fa; 
            overflow-x: hidden;
        }
        
        /* --- SIDEBAR STYLE --- */
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(180deg, #28a745 0%, #20c997 100%);
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            width: 260px;
            padding-top: 20px;
            z-index: 1050;
            transition: all 0.3s;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar .nav-link {
            color: rgba(255,255,255,0.9);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 4px 15px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }
        
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(255,255,255,0.2);
            color: white;
            transform: translateX(5px);
        }

        /* --- MAIN CONTENT STYLE (FIX CROPPING) --- */
        .main-content {
            margin-left: 260px;
            padding: 30px;
            width: calc(100% - 260px);
            min-height: 100vh;
            transition: all 0.3s;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            transition: transform 0.3s;
            border: 1px solid rgba(0,0,0,0.02);
            height: 100%;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        /* Custom Tabs for Modal */
        .redeem-tabs .nav-link {
            font-weight: 600;
            color: #212529;
            background: #fff;
            border: 1px solid #dee2e6;
            transition: all 0.3s;
        }
        .redeem-tabs .nav-link.active {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white !important;
            border-color: #28a745;
        }

        @media (max-width: 992px) {
            .sidebar { left: -260px; }
            .sidebar.active { left: 0; }
            .main-content { margin-left: 0; width: 100%; padding: 20px; }
        }
    </style>
</head>
<body>
    
    <div class="d-lg-none p-3 bg-white shadow-sm sticky-top d-flex justify-content-between align-items-center">
        <span class="fw-bold text-success">RECHAIN USER</span>
        <button class="btn btn-outline-success" onclick="document.querySelector('.sidebar').classList.toggle('active')">
            <i class="bi bi-list"></i> Menu
        </button>
    </div>

    <div class="sidebar">
        <div class="text-center mb-4 px-3">
            <img src="assets/images/logo-rechain-oil.png" alt="RECHAIN OIL" class="mb-3 bg-white rounded-circle p-1" style="height: 50px; width: 50px; object-fit: contain;">
            <h6 class="mb-0 fw-bold" id="userName">User Demo</h6>
            <small class="text-white-50" style="font-size: 0.8rem;">Kontributor Lingkungan</small>
        </div>
        
        <nav class="nav flex-column">
            <a class="nav-link active" href="#" onclick="showSection('dashboard')"><i class="bi bi-speedometer2 me-3"></i>Dashboard</a>
            <a class="nav-link" href="#" onclick="showSection('setor')"><i class="bi bi-droplet-fill me-3"></i>Setor Minyak</a>
            <a class="nav-link" href="#" onclick="showSection('riwayat')"><i class="bi bi-clock-history me-3"></i>Riwayat</a>
            <a class="nav-link" href="#" onclick="showSection('token')"><i class="bi bi-coin me-3"></i>Token Saya</a>
            <a class="nav-link" href="#" onclick="showSection('profile')"><i class="bi bi-person me-3"></i>Profil Saya</a>
        </nav>
        
        <div class="mt-auto p-3 position-absolute bottom-0 w-100">
            <div class="border-top border-white border-opacity-25 pt-3">
                <a href="#" onclick="logout()" class="nav-link text-white justify-content-center bg-white bg-opacity-10 rounded">
                    <i class="bi bi-box-arrow-right me-2"></i>Logout
                </a>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="container-fluid p-0">
            
            <div id="dashboardSection">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="fw-bold mb-0 text-dark">Dashboard</h2>
                        <p class="text-muted mb-0">Selamat datang kembali di ReChain Oil!</p>
                    </div>
                    <span class="badge bg-warning text-dark px-3 py-2 rounded-pill shadow-sm fs-6">
                        <i class="bi bi-coin me-2"></i><span id="totalTokens">0</span> RCT
                    </span>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-12 col-sm-6 col-xl-3">
                        <div class="stat-card">
                            <div class="d-flex align-items-center">
                                <div class="bg-success bg-opacity-10 p-3 rounded-circle"><i class="bi bi-droplet-fill fs-3 text-success"></i></div>
                                <div class="ms-3"><h6 class="text-muted mb-1 small text-uppercase">Total Setoran</h6><h3 class="mb-0 fw-bold" id="totalLiter">0 L</h3></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-xl-3">
                        <div class="stat-card">
                            <div class="d-flex align-items-center">
                                <div class="bg-warning bg-opacity-10 p-3 rounded-circle"><i class="bi bi-coin fs-3 text-warning"></i></div>
                                <div class="ms-3"><h6 class="text-muted mb-1 small text-uppercase">Token Dimiliki</h6><h3 class="mb-0 fw-bold" id="totalTokensCard">0 RCT</h3></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-xl-3">
                        <div class="stat-card">
                            <div class="d-flex align-items-center">
                                <div class="bg-primary bg-opacity-10 p-3 rounded-circle"><i class="bi bi-receipt fs-3 text-primary"></i></div>
                                <div class="ms-3"><h6 class="text-muted mb-1 small text-uppercase">Total Transaksi</h6><h3 class="mb-0 fw-bold" id="totalTransaksi">0</h3></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-xl-3">
                        <div class="stat-card">
                            <div class="d-flex align-items-center">
                                <div class="bg-info bg-opacity-10 p-3 rounded-circle"><i class="bi bi-tree fs-3 text-info"></i></div>
                                <div class="ms-3"><h6 class="text-muted mb-1 small text-uppercase">CO₂ Saved</h6><h3 class="mb-0 fw-bold" id="co2Saved">0 kg</h3></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-header bg-white py-3 border-bottom-0 rounded-top-4 d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-bold">Transaksi Terbaru</h6>
                        <a href="#" onclick="showSection('riwayat')" class="text-decoration-none small">Lihat Semua</a>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Tanggal</th>
                                        <th>Volume</th>
                                        <th>Lokasi</th>
                                        <th>Token</th>
                                        <th>Status</th>
                                        <th>Hash</th>
                                    </tr>
                                </thead>
                                <tbody id="recentTransactions">
                                    <tr><td colspan="6" class="text-center text-muted py-4">Belum ada transaksi</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="setorSection" style="display: none;">
                <h3 class="fw-bold mb-4">Setor Minyak Jelantah</h3>
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm rounded-4">
                            <div class="card-header bg-success text-white py-3 rounded-top-4">
                                <h5 class="mb-0 fw-bold"><i class="bi bi-droplet-fill me-2"></i>Formulir Penyetoran</h5>
                            </div>
                            <div class="card-body p-4">
                                <form id="setorForm">
                                    <div class="mb-4">
                                        <label class="form-label fw-semibold">Jumlah Minyak</label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text"><i class="bi bi-droplet"></i></span>
                                            <input type="number" class="form-control" id="jumlahMinyak" min="1" step="0.1" placeholder="Masukkan jumlah liter" required>
                                            <span class="input-group-text">Liter</span>
                                        </div>
                                    </div>

                                    <div class="row g-3 mb-3">
                                        <div class="col-md-4">
                                            <label class="form-label fw-semibold">Provinsi</label>
                                            <select class="form-select" id="selectProvinsi" required><option value="">Pilih...</option></select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-semibold">Kota/Kabupaten</label>
                                            <select class="form-select" id="selectKota" disabled required><option value="">Pilih...</option></select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-semibold">Kecamatan</label>
                                            <select class="form-select" id="selectKecamatan" disabled required><option value="">Pilih...</option></select>
                                        </div>
                                    </div>

                                    <div class="mb-4">
                                        <label class="form-label fw-semibold">Mitra Pengumpul</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-shop"></i></span>
                                            <select class="form-select" id="mitraSelect" required>
                                                <option value="">Pilih Mitra Terdekat</option>
                                                <option value="mitra1">Mitra Collection Point A</option>
                                                <option value="mitra2">CV. Berkah Jelantah</option>
                                                <option value="mitra3">Bank Sampah Induk</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="alert alert-success border-0 rounded-3">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-coin fs-4 me-3"></i>
                                            <div>
                                                <strong>Estimasi Token:</strong> <span id="estimasiToken" class="fs-5 fw-bold">0 RCT</span>
                                                <div class="small">Rate saat ini: 1 Liter = 10 RCT</div>
                                            </div>
                                        </div>
                                    </div>

                                    <button type="submit" class="btn btn-success btn-lg w-100 rounded-pill mt-3 shadow-sm">
                                        <i class="bi bi-send me-2"></i>Kirim Permintaan Setoran
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="riwayatSection" style="display: none;">
                <h3 class="fw-bold mb-4">Riwayat Transaksi</h3>
                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">No</th>
                                        <th>Waktu</th>
                                        <th>Aktivitas</th>
                                        <th>Lokasi</th>
                                        <th>Mitra/Tujuan</th>
                                        <th>Token</th>
                                        <th>Status</th>
                                        <th>Ref/Hash</th>
                                    </tr>
                                </thead>
                                <tbody id="allTransactions">
                                    <tr><td colspan="8" class="text-center text-muted py-4">Belum ada data</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tokenSection" style="display: none;">
                <h3 class="fw-bold mb-4">Dompet Token Saya</h3>
                
                <div class="row g-4 mb-4 align-items-stretch">
                    <div class="col-lg-4 d-flex">
                        <div class="card border-0 shadow-sm w-100 rounded-4 h-100">
                            <div class="card-body text-center p-4 d-flex flex-column justify-content-center align-items-center">
                                <div class="mb-3 p-3 rounded-circle bg-warning bg-opacity-10">
                                    <i class="bi bi-coin text-warning" style="font-size: 3.5rem;"></i>
                                </div>
                                <h2 class="fw-bold mb-1 display-6 text-dark">
                                    <span id="tokenPageBalance">0</span> RCT
                                </h2>
                                <p class="text-muted small mb-4">Total Aset Token</p>
                                <button class="btn btn-warning w-100 py-2 fw-bold text-dark rounded-pill shadow-sm" data-bs-toggle="modal" data-bs-target="#redeemModal">
                                    <i class="bi bi-arrow-repeat me-2"></i>Tukar Token
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8 d-flex">
                        <div class="card border-0 shadow-sm w-100 rounded-4 h-100">
                            <div class="card-header bg-white py-3 border-bottom-0 rounded-top-4 d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0 fw-bold">Grafik Harga RCT</h6>
                                    <small class="text-muted" style="font-size: 0.75rem;">Update Real-time</small>
                                </div>
                                <span class="badge bg-success bg-opacity-10 text-success rounded-pill px-3">
                                    <i class="bi bi-caret-up-fill me-1"></i>IDR 1.627 / RCT
                                </span>
                            </div>
                            
                            <div class="card-body py-2 pt-0 px-3">
                                <div style="position: relative; height: 320px; width: 100%;">
                                    <canvas id="tokenChartCanvas"></canvas>
                                </div>
                            </div>

                            <div class="card-footer bg-white border-top-0 rounded-bottom-4 pt-0 pb-3 px-3 mt-auto">
                                <div class="btn-group btn-group-sm w-100" role="group" id="chartTimeframeSelector">
                                    <input type="radio" class="btn-check" name="timeframe" id="tf1D" value="1D" checked>
                                    <label class="btn btn-outline-secondary btn-sm" for="tf1D" onclick="changeChartTimeframe('1D')">1D</label>
                                    <input type="radio" class="btn-check" name="timeframe" id="tf1W" value="1W">
                                    <label class="btn btn-outline-secondary btn-sm" for="tf1W" onclick="changeChartTimeframe('1W')">1W</label>
                                    <input type="radio" class="btn-check" name="timeframe" id="tf1M" value="1M">
                                    <label class="btn btn-outline-secondary btn-sm" for="tf1M" onclick="changeChartTimeframe('1M')">1M</label>
                                    <input type="radio" class="btn-check" name="timeframe" id="tfYTD" value="YTD">
                                    <label class="btn btn-outline-secondary btn-sm" for="tfYTD" onclick="changeChartTimeframe('YTD')">YTD</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                    <div class="card-header bg-white py-3 border-bottom-0">
                        <h6 class="mb-0 fw-bold"><i class="bi bi-list-ul me-2"></i>Riwayat Mutasi Token</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-4">Tanggal</th>
                                        <th>Aktivitas</th>
                                        <th>Jumlah</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="tokenHistoryTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="profileSection" style="display: none;">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm rounded-4">
                            <div class="card-header bg-white py-3 border-bottom-0 rounded-top-4">
                                <h5 class="mb-0 fw-bold"><i class="bi bi-person me-2"></i>Profil Saya</h5>
                            </div>
                            <div class="card-body p-4">
                                <div class="text-center mb-4">
                                    <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 100px; height: 100px;">
                                        <i class="bi bi-person-fill display-4 text-success"></i>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Nama Lengkap</label>
                                    <input type="text" class="form-control" id="profileName" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Email</label>
                                    <input type="email" class="form-control" id="profileEmail" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Nomor Telepon</label>
                                    <input type="tel" class="form-control" value="08123456789" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Alamat</label>
                                    <textarea class="form-control" rows="3" readonly>Jakarta, Indonesia</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div> </div> <div class="modal fade" id="redeemModal" tabindex="-1" aria-labelledby="redeemModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg">
          <div class="modal-header bg-success text-white rounded-top-4">
            <h5 class="modal-title" id="redeemModalLabel">Tukar Token (Withdraw)</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          
          <form id="redeemForm" class="needs-validation" novalidate>
            <div class="modal-body pb-2">
                <div class="alert alert-info border-0 text-center mb-3" role="alert">
                    Saldo Anda: <strong id="modalCurrentBalance" class="fs-5">0 RCT</strong>
                </div>

                <ul class="nav nav-pills nav-fill mb-4 p-1 bg-light rounded-pill redeem-tabs" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active rounded-pill py-2" id="tab-ewallet" data-bs-toggle="pill" data-bs-target="#content-ewallet" type="button" role="tab"><i class="bi bi-wallet2 me-1"></i>E-Wallet</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link rounded-pill py-2" id="tab-banking" data-bs-toggle="pill" data-bs-target="#content-banking" type="button" role="tab"><i class="bi bi-bank me-1"></i>M-Banking</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link rounded-pill py-2" id="tab-crypto" data-bs-toggle="pill" data-bs-target="#content-crypto" type="button" role="tab"><i class="bi bi-currency-bitcoin me-1"></i>Crypto</button>
                    </li>
                </ul>

                <div class="card border-success border-2 shadow-sm mb-3 bg-light">
                    <div class="card-body p-3">
                        <label class="form-label fw-bold small text-muted">Jumlah Token RCT yang Ditarik</label>
                        <div class="input-group">
                            <input type="number" class="form-control form-control-lg text-dark fw-bold" id="redeemAmount" min="10" required placeholder="Min. 10" oninput="updateRupiahPreview()">
                            <span class="input-group-text bg-white text-success fw-bold">RCT</span>
                        </div>
                        <p class="text-success fw-bold mt-2 mb-0 small" id="rupiahPreview">Anda akan menerima ≈ Rp 0</p>
                        <p class="text-muted small mt-1 mb-0">Rate: 1 RCT = Rp 1.627</p>
                    </div>
                </div>

                <div class="tab-content border-0">
                    <div class="tab-pane fade show active" id="content-ewallet" role="tabpanel">
                        <div class="mb-3">
                            <label class="form-label">Pilih E-Wallet</label>
                            <select class="form-select" id="redeemEwallet" required>
                                <option value="">Pilih Tujuan</option>
                                <option value="gopay">GoPay</option>
                                <option value="ovo">OVO</option>
                                <option value="dana">DANA</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nomor HP/ID Akun</label>
                            <input type="text" class="form-control" id="ewalletAccount" required placeholder="Contoh: 08123456789">
                        </div>
                    </div>

                    <div class="tab-pane fade" id="content-banking" role="tabpanel">
                        <div class="mb-3">
                            <label class="form-label">Nama Bank</label>
                            <select class="form-select" id="redeemBank" required>
                                <option value="">Pilih Bank</option>
                                <option value="bca">BCA</option>
                                <option value="mandiri">Mandiri</option>
                                <option value="bni">BNI</option>
                                <option value="bri">BRI</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nomor Rekening</label>
                            <input type="text" class="form-control" id="bankAccount" required placeholder="Contoh: 1234567890">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nama Pemilik Rekening</label>
                            <input type="text" class="form-control" id="bankHolder" required placeholder="Contoh: Budi Santoso">
                        </div>
                    </div>

                    <div class="tab-pane fade" id="content-crypto" role="tabpanel">
                        <div class="mb-3">
                            <label class="form-label">Alamat Wallet (ERC-20/BEP-20)</label>
                            <input type="text" class="form-control" id="cryptoAddress" required placeholder="0x...">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Pilih Token</label>
                            <select class="form-select" id="cryptoToken" required>
                                <option value="usdt">USDT</option>
                                <option value="eth">ETH</option>
                                <option value="bnb">BNB</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <p class="text-danger small text-center mt-3" id="redeemWarning" style="display:none;"></p>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="submit" class="btn btn-success" id="btnProsesRedeem">Proses Penarikan</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Check authentication
        if (!localStorage.getItem('userRole') || localStorage.getItem('userRole') !== 'user') {
            window.location.href = 'login.html';
        }

        // ==========================================
        // 1. DATA INITIALIZATION & GETTERS
        // ==========================================
        const currentUserEmail = localStorage.getItem('userEmail') || ''; 
        const currentUserName = localStorage.getItem('userName') || 'User';
        
        document.getElementById('userName').textContent = currentUserName;
        document.getElementById('profileName').value = currentUserName;
        document.getElementById('profileEmail').value = currentUserEmail;

        const transactionStorageKey = 'userTransactions_' + currentUserEmail;
        const redeemHistoryKey = 'redeemHistory_' + currentUserEmail;

        function getTransactions() {
            return JSON.parse(localStorage.getItem(transactionStorageKey) || '[]');
        }
        function getRedeemHistory() {
            return JSON.parse(localStorage.getItem(redeemHistoryKey) || '[]');
        }
        
        let tokenChartInitialized = false;

        // ==========================================
        // 2. LOGIKA PENARIKAN (REDEEM)
        // ==========================================
        function updateRupiahPreview() {
            const rate = 1627;
            const redeemAmount = parseFloat(document.getElementById('redeemAmount').value) || 0;
            const rupiahValue = Math.floor(redeemAmount * rate);
            document.getElementById('rupiahPreview').textContent = `Anda akan menerima ≈ Rp ${rupiahValue.toLocaleString('id-ID')}`;
        }
        window.updateRupiahPreview = updateRupiahPreview;

        function calculateCurrentBalance() {
             const freshTransactions = getTransactions();
             const freshRedeemHistory = getRedeemHistory();
             const totalTokensEarned = freshTransactions.reduce((sum, t) => sum + parseInt(t.tokens || 0), 0);
             const totalTokensSpent = freshRedeemHistory.reduce((sum, r) => sum + parseInt(r.amount || 0), 0);
             return totalTokensEarned - totalTokensSpent;
        }

        function handleRedeemSubmit(e) {
            e.preventDefault();
            const redeemAmount = parseInt(document.getElementById('redeemAmount').value);
            const currentBalance = calculateCurrentBalance();
            const redeemWarning = document.getElementById('redeemWarning');
            redeemWarning.style.display = 'none';

            if (redeemAmount > currentBalance || redeemAmount < 10) {
                redeemWarning.textContent = redeemAmount < 10 ? 'ERROR: Minimal penarikan adalah 10 RCT.' : 'ERROR: Saldo token tidak mencukupi.';
                redeemWarning.style.display = 'block';
                return;
            }

            let destination = '';
            let accountInfo = '';
            const activeTabButton = document.querySelector('.nav-pills .nav-link.active');
            const activeTabId = activeTabButton ? activeTabButton.id : '';

            if (activeTabId === 'tab-ewallet') {
                destination = document.getElementById('redeemEwallet').value;
                accountInfo = document.getElementById('ewalletAccount').value;
            } else if (activeTabId === 'tab-banking') {
                destination = document.getElementById('redeemBank').value;
                accountInfo = `Rek: ${document.getElementById('bankAccount').value} An: ${document.getElementById('bankHolder').value}`;
            } else if (activeTabId === 'tab-crypto') {
                destination = document.getElementById('cryptoToken').value;
                accountInfo = `Wallet: ${document.getElementById('cryptoAddress').value}`;
            }

            if (!destination || !accountInfo) {
                 redeemWarning.textContent = 'ERROR: Mohon lengkapi semua field tujuan penarikan.';
                 redeemWarning.style.display = 'block';
                 return;
            }

            if (confirm(`Konfirmasi penarikan ${redeemAmount} RCT ke ${destination}?`)) {
                const redemption = {
                    date: new Date().toISOString(),
                    amount: redeemAmount,
                    destination: destination,
                    account: accountInfo,
                    status: 'Pending'
                };
                let currentRedeemHistory = getRedeemHistory();
                currentRedeemHistory.push(redemption);
                localStorage.setItem(redeemHistoryKey, JSON.stringify(currentRedeemHistory));
                
                const redeemModal = bootstrap.Modal.getInstance(document.getElementById('redeemModal'));
                if(redeemModal) redeemModal.hide();
                alert(`Permintaan penarikan ${redeemAmount} RCT berhasil diajukan!`);
                updateDashboard();
            }
        }
        
        document.getElementById('redeemForm')?.addEventListener('submit', handleRedeemSubmit);

        document.getElementById('redeemModal')?.addEventListener('show.bs.modal', function() {
            updateTokenPageData(); 
            const cardBalanceText = document.getElementById('tokenPageBalance').textContent;
            document.getElementById('modalCurrentBalance').textContent = cardBalanceText + ' RCT';
            document.getElementById('redeemWarning').style.display = 'none';
        });

        // ==========================================
        // 3. FUNGSI GRAFIK & DATA
        // ==========================================
        const chartDataStore = {
            '1D': { labels: ['02:00', '03:00', '04:00', '05:00', '06:00', '07:00', '08:00', '09:00'], data: [1620, 1621, 1623, 1621, 1625, 1627, 1624, 1627] },
            '1W': { labels: ['28 Nov', '29 Nov', '30 Nov', '1 Des', '2 Des', '3 Des', '4 Des'], data: [1590, 1600, 1605, 1615, 1620, 1623, 1627] },
            '1M': { labels: ['3 Nov', '10 Nov', '17 Nov', '24 Nov', '4 Des'], data: [1500, 1540, 1580, 1600, 1627] },
            'YTD': { labels: ['Jan 1', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', '4 Des 25'], data: [1400, 1450, 1420, 1500, 1530, 1580, 1550, 1600, 1590, 1610, 1630, 1627] }
        };

        function changeChartTimeframe(timeframe) {
            document.querySelectorAll('#chartTimeframeSelector label').forEach(label => { label.classList.remove('active'); });
            document.getElementById(`tf${timeframe}`).checked = true;
            document.querySelector(`label[for="tf${timeframe}"]`).classList.add('active');

            if (window.myTokenChart && chartDataStore[timeframe]) {
                const newData = chartDataStore[timeframe];
                window.myTokenChart.data.labels = newData.labels;
                window.myTokenChart.data.datasets[0].data = newData.data;
                window.myTokenChart.update();
            }
        }

        function initTokenPageChart() {
            const ctxToken = document.getElementById('tokenChartCanvas');
            if(!ctxToken) return;
            if (window.myTokenChart) { window.myTokenChart.destroy(); }
            const defaultData = chartDataStore['1D']; 
            window.myTokenChart = new Chart(ctxToken, {
                type: 'line',
                data: { labels: defaultData.labels, datasets: [{ label: 'Harga (IDR)', data: defaultData.data, borderColor: '#ffc107', backgroundColor: (context) => { const ctx = context.chart.ctx; const gradient = ctx.createLinearGradient(0, 0, 0, 200); gradient.addColorStop(0, 'rgba(255, 193, 7, 0.2)'); gradient.addColorStop(1, 'rgba(255, 193, 7, 0)'); return gradient; }, borderWidth: 2, tension: 0.4, fill: true, pointBackgroundColor: '#fff', pointBorderColor: '#ffc107', pointRadius: 3, pointHoverRadius: 5 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }, scales: { x: { grid: { display: false }, ticks: { font: { size: 10 } } }, y: { grid: { borderDash: [5, 5] }, ticks: { callback: function(value) { return 'Rp ' + value.toLocaleString('id-ID'); }, font: { size: 10 } }, beginAtZero: false } } }
            });
            document.querySelector('label[for="tf1D"]').classList.add('active');
        }

        // ==========================================
        // 4. UPDATE DATA
        // ==========================================
        function updateDashboard() {
            const currentBalance = calculateCurrentBalance();
            const transactions = getTransactions();
            const redeemHistory = getRedeemHistory();
            const totalLiter = transactions.reduce((sum, t) => sum + parseFloat(t.volume || 0), 0);
            const co2Saved = (totalLiter * 2.5).toFixed(2);
            
            if(document.getElementById('totalLiter')) document.getElementById('totalLiter').textContent = totalLiter.toFixed(1) + ' L';
            if(document.getElementById('totalTokensCard')) document.getElementById('totalTokensCard').textContent = currentBalance + ' RCT'; 
            if(document.getElementById('totalTransaksi')) document.getElementById('totalTransaksi').textContent = transactions.length + redeemHistory.length;
            if(document.getElementById('co2Saved')) document.getElementById('co2Saved').textContent = co2Saved + ' kg';
            if(document.getElementById('totalTokens')) document.getElementById('totalTokens').textContent = currentBalance; 
            
            const recent = transactions.slice(-5).reverse();
            const tbody = document.getElementById('recentTransactions');
            if (tbody) {
                if (recent.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">Belum ada transaksi</td></tr>';
                } else {
                    tbody.innerHTML = recent.map(t => `<tr><td class="ps-4">${new Date(t.date).toLocaleDateString('id-ID')}</td><td><strong>${t.volume} L</strong></td><td>${t.location}</td><td><span class="badge bg-warning text-dark rounded-pill px-3">${t.tokens} RCT</span></td><td><span class="badge bg-success rounded-pill px-3">Verified</span></td><td><small class="text-muted text-truncate d-inline-block" style="max-width: 100px;">${t.hash || '-'}</small></td></tr>`).join('');
                }
            }
        }

        function updateTokenPageData() {
            const currentBalance = calculateCurrentBalance();
            const transactions = getTransactions();
            const redeemHistory = getRedeemHistory();
            const elBalance = document.getElementById('tokenPageBalance');
            if(elBalance) elBalance.textContent = currentBalance;

            const combinedHistory = [
                ...transactions.map(t => ({ type: 'earned', date: t.date, amount: t.tokens, desc: `Setor Minyak (${t.volume}L)` })),
                ...redeemHistory.map(r => ({ type: 'spent', date: r.date, amount: r.amount, desc: `Penarikan ke ${r.destination.toUpperCase()}` }))
            ].sort((a, b) => new Date(b.date) - new Date(a.date));

            const tbody = document.getElementById('tokenHistoryTable');
            if(tbody) {
                if (combinedHistory.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4 small">Belum ada riwayat token</td></tr>';
                } else {
                    tbody.innerHTML = combinedHistory.map(item => `<tr><td class="ps-4 small fw-semibold">${new Date(item.date).toLocaleDateString('id-ID')}</td><td class="small">${item.desc}</td><td class="small ${item.type === 'earned' ? 'text-success fw-bold' : 'text-danger fw-bold'}">${item.type === 'earned' ? '+' : '-'}${item.amount} RCT</td><td><span class="badge ${item.type === 'earned' ? 'bg-success' : 'bg-warning'} bg-opacity-10 ${item.type === 'earned' ? 'text-success' : 'text-warning'} rounded-pill px-2" style="font-size: 0.7rem;">${item.type === 'earned' ? 'Sukses' : 'Pending'}</span></td></tr>`).join('');
                }
            }
        }

        // ==========================================
        // 5. NAVIGATION
        // ==========================================
        function showSection(section) {
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('setorSection').style.display = 'none';
            document.getElementById('riwayatSection').style.display = 'none';
            document.getElementById('tokenSection').style.display = 'none';
            document.getElementById('profileSection').style.display = 'none';

            if (section === 'token') {
                document.getElementById('tokenSection').style.display = 'block';
                if (!tokenChartInitialized) { setTimeout(() => { initTokenPageChart(); tokenChartInitialized = true; }, 50); } 
                else if (window.myTokenChart) { window.myTokenChart.resize(); }
                updateTokenPageData(); 
            } else if (section === 'setor') {
                document.getElementById('setorSection').style.display = 'block';
            } else if (section === 'riwayat') {
                document.getElementById('riwayatSection').style.display = 'block';
                const transactions = getTransactions();
                const redeemHistory = getRedeemHistory();
                const tbody = document.getElementById('allTransactions');
                if(tbody) {
                    const allTbody = [
                        ...transactions.map(t => ({...t, type: 'earning', tokens: `+${t.tokens}`})),
                        ...redeemHistory.map(r => ({...r, type: 'spending', tokens: `-${r.amount}`}))
                    ].sort((a, b) => new Date(b.date) - new Date(a.date));

                     if (allTbody.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">Belum ada transaksi</td></tr>';
                    } else {
                        tbody.innerHTML = allTbody.map((t, i) => {
                            if(t.type === 'earning') {
                                return `<tr><td>#${i + 1}</td><td>${new Date(t.date).toLocaleString('id-ID')}</td><td>${t.volume} L</td><td>${t.location}</td><td>${t.mitra}</td><td><span class="badge bg-success">${t.tokens} RCT</span></td><td><span class="badge bg-success">Verified</span></td><td><small class="text-monospace">${t.hash}</small></td></tr>`;
                            } else {
                                return `<tr class="table-warning bg-opacity-25"><td>#${i + 1}</td><td>${new Date(t.date).toLocaleString('id-ID')}</td><td>-</td><td>Penarikan</td><td>${t.destination.toUpperCase()}</td><td><span class="badge bg-danger">${t.tokens} RCT</span></td><td><span class="badge bg-warning text-dark">Pending</span></td><td>-</td></tr>`;
                            }
                        }).join('');
                    }
                }
            } else if (section === 'profile') {
                document.getElementById('profileSection').style.display = 'block';
            } else {
                document.getElementById('dashboardSection').style.display = 'block';
            }

            document.querySelectorAll('.sidebar .nav-link').forEach(link => link.classList.remove('active'));
            if(event && event.target) {
                if(event.target.classList.contains('nav-link')) event.target.classList.add('active');
                else if(event.target.closest('.nav-link')) event.target.closest('.nav-link').classList.add('active');
            }
        }

        // ==========================================
        // 6. SETOR MINYAK
        // ==========================================
        const inputMinyak = document.getElementById('jumlahMinyak');
        const displayEstimasi = document.getElementById('estimasiToken');
        if (inputMinyak && displayEstimasi) {
            inputMinyak.addEventListener('input', function() {
                const liter = parseFloat(this.value) || 0;
                const totalToken = Math.floor(liter * 10);
                displayEstimasi.textContent = totalToken + " RCT";
            });
        }

        document.getElementById('setorForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const volume = parseFloat(document.getElementById('jumlahMinyak').value);
            const elProvinsi = document.getElementById('selectProvinsi');
            const elKota = document.getElementById('selectKota');
            const elKecamatan = document.getElementById('selectKecamatan');
            const textProvinsi = elProvinsi.options[elProvinsi.selectedIndex].getAttribute('data-name');
            const textKota = elKota.options[elKota.selectedIndex].getAttribute('data-name');
            const textKecamatan = elKecamatan.options[elKecamatan.selectedIndex].getAttribute('data-name');
            const locationFull = `${textKecamatan}, ${textKota}, ${textProvinsi}`;
            const mitra = document.getElementById('mitraSelect').options[document.getElementById('mitraSelect').selectedIndex].text;
            const tokens = Math.floor(volume * 10);
            const hash = '0x' + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);

            const transaction = { date: new Date().toISOString(), volume: volume, location: locationFull, mitra: mitra, tokens: tokens, hash: hash, status: 'verified' };
            
            let currentTransactions = getTransactions();
            currentTransactions.push(transaction);
            
            localStorage.setItem(transactionStorageKey, JSON.stringify(currentTransactions));

            alert('Setoran berhasil dicatat! Token akan segera dikirim setelah verifikasi mitra.');
            this.reset();
            document.getElementById('estimasiToken').textContent = '0 RCT';
            elKota.innerHTML = '<option value="">Pilih Kota/Kabupaten...</option>'; elKota.disabled = true;
            elKecamatan.innerHTML = '<option value="">Pilih Kecamatan...</option>'; elKecamatan.disabled = true;
            showSection('dashboard');
            updateDashboard();
        });

        // ==========================================
        // 7. UTILS
        // ==========================================
        function logout() {
            localStorage.removeItem('userRole'); localStorage.removeItem('userName'); localStorage.removeItem('userEmail');
            window.location.href = 'login.html';
        }

        const baseUrl = 'https://www.emsifa.com/api-wilayah-indonesia/api';
        const elProvinsi = document.getElementById('selectProvinsi');
        const elKota = document.getElementById('selectKota');
        const elKecamatan = document.getElementById('selectKecamatan');

        if(elProvinsi) {
            fetch(`${baseUrl}/provinces.json`).then(r => r.json()).then(data => {
                let options = '<option value="">Pilih Provinsi...</option>';
                data.forEach(p => options += `<option value="${p.id}" data-name="${p.name}">${p.name}</option>`);
                elProvinsi.innerHTML = options;
            });
            elProvinsi.addEventListener('change', function() {
                const id = this.value; elKota.innerHTML = '<option value="">Loading...</option>'; elKota.disabled = true;
                if(id) fetch(`${baseUrl}/regencies/${id}.json`).then(r => r.json()).then(data => {
                    let options = '<option value="">Pilih Kota/Kabupaten...</option>';
                    data.forEach(c => options += `<option value="${c.id}" data-name="${c.name}">${c.name}</option>`);
                    elKota.innerHTML = options; elKota.disabled = false;
                });
            });
            elKota.addEventListener('change', function() {
                const id = this.value; elKecamatan.innerHTML = '<option value="">Loading...</option>'; elKecamatan.disabled = true;
                if(id) fetch(`${baseUrl}/districts/${id}.json`).then(r => r.json()).then(data => {
                    let options = '<option value="">Pilih Kecamatan...</option>';
                    data.forEach(d => options += `<option value="${d.id}" data-name="${d.name}">${d.name}</option>`);
                    elKecamatan.innerHTML = options; elKecamatan.disabled = false;
                });
            });
        }

        window.changeChartTimeframe = changeChartTimeframe;
        window.logout = logout;
        window.showSection = showSection;
        
        document.addEventListener('DOMContentLoaded', function() {
            updateDashboard();
        });
    </script>
</body>
</html>